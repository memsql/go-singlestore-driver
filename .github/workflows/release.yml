name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'

jobs:
  test:
    uses: ./.github/workflows/test.yml
    secrets: inherit

  release:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tag is on master branch
        id: check_branch
        run: |
          git fetch origin master:master
          if git merge-base --is-ancestor ${{ github.sha }} origin/master; then
            echo "on_master=true" >> $GITHUB_OUTPUT
          else
            echo "on_master=false" >> $GITHUB_OUTPUT
            echo "Tag ${{ github.ref_name }} is not on master branch"
            exit 1
          fi

      - name: Extract release notes
        id: extract_notes
        run: |
          TAG="${{ github.ref_name }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Check if CHANGELOG.md exists
          if [ -f "CHANGELOG.md" ]; then
            # Try to extract release notes from CHANGELOG
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            awk "/^## \[?${TAG#v}\]?/,/^## \[?[0-9]/" CHANGELOG.md | sed '1d;$d' >> $GITHUB_OUTPUT || echo "See CHANGELOG.md for details" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "notes=Release $TAG" >> $GITHUB_OUTPUT
          fi

      - name: Determine if pre-release
        id: prerelease
        run: |
          TAG="${{ github.ref_name }}"
          if [[ "$TAG" =~ -(alpha|beta|rc) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: ${{ steps.extract_notes.outputs.notes }}
          draft: false
          prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
